<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="refresh" content="2">
    <title>QA Entomologist - Live Dashboard</title>
    <script src="vis-network.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0f;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-bottom: 1px solid #2a2a4a;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 56px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #00d2ff, #7b2ff7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header .subtitle { font-size: 11px; color: #888; margin-top: 2px; }

        .stats { display: flex; gap: 24px; }
        .stat { text-align: center; }
        .stat-value { font-size: 22px; font-weight: 700; color: #00d2ff; }
        .stat-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }

        .tabs {
            display: flex; gap: 2px;
            background: #111122; border-radius: 8px; padding: 3px;
        }
        .tab {
            padding: 8px 18px; border: none; border-radius: 6px;
            background: transparent; color: #888; cursor: pointer;
            font-size: 13px; font-weight: 500; transition: all 0.2s;
        }
        .tab:hover { color: #ccc; background: #1a1a2e; }
        .tab.active { background: #00d2ff22; color: #00d2ff; }

        .controls { display: flex; gap: 8px; align-items: center; }
        .btn {
            padding: 7px 14px; border: 1px solid #3a3a5a; border-radius: 6px;
            background: #1a1a2e; color: #e0e0e0; cursor: pointer;
            font-size: 12px; transition: all 0.2s;
        }
        .btn:hover { background: #2a2a4a; border-color: #00d2ff; }
        .btn.active { background: #00d2ff22; border-color: #00d2ff; color: #00d2ff; }

        .pulse {
            display: inline-block; width: 8px; height: 8px; border-radius: 50%;
            background: #22c55e; animation: pulse 1.5s infinite; margin-right: 6px;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        .main { height: calc(100vh - 56px); overflow: hidden; }
        .tab-content { display: none; height: 100%; }
        .tab-content.active { display: flex; }

        /* Graph Tab */
        #graph-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #0a0a0f;
        }

        .sidebar {
            width: 320px; background: #111122;
            border-left: 1px solid #2a2a4a; overflow-y: auto; padding: 16px;
        }
        .sidebar h3 {
            font-size: 13px; color: #00d2ff; margin-bottom: 10px;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .page-card {
            background: #1a1a2e; border: 1px solid #2a2a4a;
            border-radius: 8px; padding: 10px; margin-bottom: 6px;
            cursor: pointer; transition: all 0.2s;
        }
        .page-card:hover { border-color: #00d2ff; background: #1a1a3e; }
        .page-card.selected { border-color: #7b2ff7; background: #1a1a3e; }
        .page-card .title { font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .page-card .url { font-size: 10px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
        .page-card .obs { font-size: 10px; color: #888; margin-top: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .page-card .meta { display: flex; gap: 6px; margin-top: 4px; }
        .page-card .badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; background: #2a2a4a; color: #aaa; }
        .page-card .badge.depth { background: #7b2ff722; color: #7b2ff7; }
        .page-card .badge.type { background: #00d2ff22; color: #00d2ff; }

        .legend { display: flex; gap: 12px; margin-top: 10px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 10px; color: #888; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

        .empty-state {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; color: #555; z-index: 5;
        }
        .empty-state p { margin-top: 12px; font-size: 14px; }
        .empty-state code { background: #1a1a2e; padding: 8px 16px; border-radius: 6px; margin-top: 12px; font-size: 13px; color: #00d2ff; }

        /* Test Cases Tab */
        .test-cases-layout { display: flex; width: 100%; height: 100%; }
        .test-panel {
            flex: 1; overflow-y: auto; padding: 20px 24px;
            border-right: 1px solid #2a2a4a;
        }
        .test-panel:last-child { border-right: none; }
        .test-panel h2 {
            font-size: 16px; font-weight: 700; margin-bottom: 16px;
            padding-bottom: 8px; border-bottom: 1px solid #2a2a4a;
        }
        .test-panel h2 .agent-badge {
            font-size: 10px; padding: 3px 8px; border-radius: 10px;
            font-weight: 600; margin-left: 8px; vertical-align: middle;
        }
        .web-badge { background: #00d2ff22; color: #00d2ff; }
        .mobile-badge { background: #7b2ff722; color: #7b2ff7; }

        .tc-card {
            background: #1a1a2e; border: 1px solid #2a2a4a;
            border-radius: 10px; padding: 16px; margin-bottom: 12px;
            transition: all 0.2s;
        }
        .tc-card:hover { border-color: #3a3a6a; }
        .tc-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .tc-id { font-size: 11px; font-weight: 700; color: #7b2ff7; font-family: monospace; }
        .tc-title { font-size: 14px; font-weight: 600; flex: 1; }
        .tc-priority { font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 700; text-transform: uppercase; }
        .p0 { background: #ef444422; color: #ef4444; }
        .p1 { background: #f9731622; color: #f97316; }
        .p2 { background: #eab30822; color: #eab308; }
        .p3 { background: #22c55e22; color: #22c55e; }

        .tc-type { font-size: 11px; color: #888; margin-bottom: 10px; }

        .tc-steps { list-style: none; }
        .tc-step { display: flex; gap: 10px; padding: 8px 0; border-top: 1px solid #1e1e3a; font-size: 12px; }
        .tc-step-num {
            min-width: 24px; height: 24px; border-radius: 50%;
            background: #2a2a4a; display: flex; align-items: center;
            justify-content: center; font-size: 10px; font-weight: 700;
            color: #00d2ff; flex-shrink: 0;
        }
        .tc-step-body { flex: 1; }
        .tc-step-action { color: #e0e0e0; line-height: 1.5; }
        .tc-step-expected { color: #22c55e; font-size: 11px; margin-top: 4px; }
        .tc-step-expected::before { content: "Expected: "; font-weight: 600; }
        .tc-step-screenshot { margin-top: 6px; }
        .tc-step-screenshot img {
            max-width: 200px; border-radius: 6px;
            border: 1px solid #2a2a4a; cursor: pointer; transition: transform 0.2s;
        }
        .tc-step-screenshot img:hover { transform: scale(1.05); }

        .tc-preconditions {
            font-size: 11px; color: #aaa; background: #15152a;
            padding: 8px 12px; border-radius: 6px; margin-bottom: 10px;
        }
        .tc-preconditions strong { color: #00d2ff; }

        .tc-empty { text-align: center; color: #555; padding: 60px 20px; }
        .tc-empty .spinner {
            width: 40px; height: 40px; border: 3px solid #2a2a4a;
            border-top: 3px solid #00d2ff; border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Screenshots Tab */
        .screenshots-layout { width: 100%; height: 100%; overflow-y: auto; padding: 20px; }
        .screenshots-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;
        }
        .ss-card {
            background: #1a1a2e; border: 1px solid #2a2a4a;
            border-radius: 10px; overflow: hidden; transition: all 0.2s;
        }
        .ss-card:hover { border-color: #00d2ff; transform: translateY(-2px); }
        .ss-card img { width: 100%; display: block; cursor: pointer; }
        .ss-card .ss-info { padding: 10px 12px; }
        .ss-card .ss-name { font-size: 11px; color: #aaa; word-break: break-all; }
        .ss-card .ss-time { font-size: 10px; color: #555; margin-top: 4px; }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.85);
            z-index: 1000; align-items: center; justify-content: center; cursor: pointer;
        }
        .modal-overlay.show { display: flex; }
        .modal-overlay img { max-width: 90vw; max-height: 90vh; border-radius: 8px; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0f; }
        ::-webkit-scrollbar-thumb { background: #2a2a4a; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #3a3a5a; }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>QA Entomologist</h1>
            <div class="subtitle">AI-Powered Test Case Generation - Live Dashboard</div>
        </div>
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="stat-pages">0</div>
                <div class="stat-label">Screens</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-edges">0</div>
                <div class="stat-label">Actions</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-tc-web">-</div>
                <div class="stat-label">Web Tests</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-tc-mobile">-</div>
                <div class="stat-label">Mobile Tests</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-screenshots">0</div>
                <div class="stat-label">Screenshots</div>
            </div>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('graph', this)">Exploration Map</button>
            <button class="tab" onclick="switchTab('testcases', this)">Test Cases</button>
            <button class="tab" onclick="switchTab('alerts', this)">Anomaly Alerts</button>
            <button class="tab" onclick="switchTab('screenshots', this)">Screenshots</button>
        </div>
        <div class="controls">
            <span class="pulse"></span>
            <button class="btn active" id="btn-auto" onclick="toggleAutoRefresh()">Live</button>
            <button class="btn" onclick="refreshAll()">Refresh</button>
        </div>
    </div>

    <div class="main">
        <div class="tab-content active" id="tab-graph">
            <div id="graph-container">
                <div class="empty-state" id="empty-state">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    <p>Waiting for exploration data...</p>
                    <code>python3 run.py https://www.example.com --headed</code>
                </div>
            </div>
            <div class="sidebar">
                <h3>Discovered Screens</h3>
                <div id="page-list"></div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-dot" style="background:#7b2ff7"></div> Home</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#00d2ff"></div> Page</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#ff9f43"></div> SPA/Modal</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#ff6b6b"></div> Deep</div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="tab-testcases">
            <div class="test-cases-layout">
                <div class="test-panel" id="web-tests">
                    <h2>Web Agent <span class="agent-badge web-badge">BROWSER</span></h2>
                    <div id="web-tc-list">
                        <div class="tc-empty">
                            <div class="spinner"></div>
                            <p>Agent is exploring... test cases will appear here.</p>
                        </div>
                    </div>
                </div>
                <div class="test-panel" id="mobile-tests">
                    <h2>Mobile Agent <span class="agent-badge mobile-badge">ANDROID</span></h2>
                    <div id="mobile-tc-list">
                        <div class="tc-empty">
                            <div class="spinner"></div>
                            <p>Agent is exploring... test cases will appear here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Anomaly Alerts Tab -->
        <div class="tab-content" id="tab-alerts">
            <div style="width:100%;height:100%;overflow-y:auto;padding:20px;">
                <h2 style="margin-bottom:16px;">Anomaly Detection & Auto-QA <span id="alert-status" style="font-size:12px;font-weight:400;color:#888;margin-left:12px;">Waiting for anomalies...</span></h2>
                <div id="alerts-content">
                    <div class="tc-empty">
                        <div class="spinner"></div>
                        <p>Monitoring for production anomalies...</p>
                        <p style="font-size:12px;color:#555;margin-top:8px;">Crashes will appear here when detected by Datadog</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="tab-screenshots">
            <div class="screenshots-layout">
                <h2 style="margin-bottom:16px;">Captured Screenshots <span id="ss-count" style="color:#888;font-size:13px;font-weight:400;"></span></h2>
                <div class="screenshots-grid" id="ss-grid">
                    <div class="tc-empty" style="grid-column:1/-1;">
                        <div class="spinner"></div>
                        <p>Screenshots will appear as agents explore...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="img-modal" onclick="this.classList.remove('show')">
        <img id="modal-img" src="" alt="Screenshot">
    </div>

    <script>
    let network = null;
    let autoRefresh = true;
    let refreshInterval = null;
    let knownScreenshots = [];

    function switchTab(tab, btn) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + tab).classList.add('active');
        if (tab === 'graph' && network) {
            setTimeout(() => { network.redraw(); network.fit(); }, 100);
        }
    }

    function showImage(src) {
        document.getElementById('modal-img').src = src;
        document.getElementById('img-modal').classList.add('show');
    }

    function truncate(str, len) { return !str ? '' : str.length > len ? str.substring(0, len) + '...' : str; }

    // ---- Graph ----
    function nodeColor(node) {
        if (node.depth === 0) return { background: '#7b2ff7', border: '#9b4fff', highlight: { background: '#9b4fff', border: '#b06fff' } };
        if (node.page_type === 'spa_view') return { background: '#ff9f43', border: '#ffbe76', highlight: { background: '#ffbe76', border: '#ffd9a0' } };
        if (node.depth >= 3) return { background: '#ff6b6b', border: '#ff8a8a', highlight: { background: '#ff8a8a', border: '#ffaaaa' } };
        return { background: '#00d2ff', border: '#33ddff', highlight: { background: '#33ddff', border: '#66eeff' } };
    }
    function edgeColor(edge) {
        if (edge.action_type === 'back') return { color: '#ff6b6b66', highlight: '#ff6b6b' };
        if (edge.action_type === 'spa_click') return { color: '#ff9f4366', highlight: '#ff9f43' };
        return { color: '#00d2ff66', highlight: '#00d2ff' };
    }

    async function loadGraph() {
        try {
            const resp = await fetch('/web/graph_data.json?t=' + Date.now(), {cache:'no-store'});
            if (!resp.ok) return;
            const data = await resp.json();
            renderGraph(data);
        } catch (e) {
            console.log('Graph not ready:', e);
        }
    }

    function renderGraph(data) {
        if (!data.nodes || data.nodes.length === 0) return;

        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('stat-pages').textContent = data.nodes.length;
        document.getElementById('stat-edges').textContent = data.edges.length;

        const nodeIds = new Set(data.nodes.map(n => n.id));

        const nodes = new vis.DataSet(data.nodes.map(n => ({
            id: n.id,
            label: truncate(n.title || n.path || n.url, 25),
            title: `${n.title || 'Unknown'}\n${n.url}\nDepth: ${n.depth}\nType: ${n.page_type || 'unknown'}`,
            color: nodeColor(n),
            font: { color: '#e0e0e0', size: 12 },
            shape: n.depth === 0 ? 'diamond' : 'dot',
            size: n.depth === 0 ? 25 : Math.max(10, 18 - n.depth * 3),
        })));

        const validEdges = data.edges.filter(e => nodeIds.has(e.from_id) && nodeIds.has(e.to_id));
        const edges = new vis.DataSet(validEdges.map((e, i) => ({
            id: 'e' + i,
            from: e.from_id,
            to: e.to_id,
            label: truncate(e.element_text, 18),
            color: edgeColor(e),
            arrows: { to: { enabled: true, scaleFactor: 0.6 } },
            font: { color: '#888', size: 10, strokeWidth: 0 },
            smooth: { type: 'curvedCW', roundness: 0.2 },
            dashes: e.action_type === 'back',
            width: e.action_type === 'back' ? 1 : 2,
        })));

        const container = document.getElementById('graph-container');

        if (network) {
            network.setData({ nodes, edges });
            setTimeout(() => network.fit({ animation: { duration: 500 } }), 300);
        } else {
            network = new vis.Network(container, { nodes, edges }, {
                physics: {
                    forceAtlas2Based: {
                        gravitationalConstant: -60,
                        centralGravity: 0.01,
                        springLength: 180,
                        springConstant: 0.06,
                        damping: 0.4,
                    },
                    solver: 'forceAtlas2Based',
                    stabilization: { iterations: 200 },
                },
                interaction: { hover: true, tooltipDelay: 200 },
                edges: { width: 2 },
                nodes: { borderWidth: 2 },
            });
            network.on('click', params => {
                if (params.nodes.length > 0) highlightPageCard(params.nodes[0]);
            });
            network.once('stabilized', () => network.fit({ animation: true }));
        }
        renderPageList(data.nodes);
    }

    function renderPageList(pages) {
        const list = document.getElementById('page-list');
        list.innerHTML = '';
        [...pages].sort((a, b) => a.depth - b.depth).forEach(p => {
            const card = document.createElement('div');
            card.className = 'page-card';
            card.dataset.id = p.id;
            const obsText = p.observations ? truncate(p.observations, 80) : '';
            card.innerHTML = `
                <div class="title">${p.title || '(untitled)'}</div>
                <div class="url">${p.url}</div>
                ${obsText ? `<div class="obs">${obsText}</div>` : ''}
                <div class="meta">
                    <span class="badge depth">depth ${p.depth}</span>
                    <span class="badge type">${p.page_type || 'unknown'}</span>
                    <span class="badge">${p.element_count || 0} elements</span>
                </div>`;
            card.onclick = () => {
                if (network) { network.selectNodes([p.id]); network.focus(p.id, { scale: 1.5, animation: true }); }
                highlightPageCard(p.id);
            };
            list.appendChild(card);
        });
    }

    function highlightPageCard(id) {
        document.querySelectorAll('.page-card').forEach(c => c.classList.remove('selected'));
        const card = document.querySelector(`.page-card[data-id="${id}"]`);
        if (card) { card.classList.add('selected'); card.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
    }

    // ---- Test Cases ----
    async function loadTestCases() {
        await loadTestrail('/testrail_export.json', 'web-tc-list', 'stat-tc-web');
        await loadTestrail('/testrail_export_mobile.json', 'mobile-tc-list', 'stat-tc-mobile');
    }

    async function loadTestrail(file, containerId, statId) {
        try {
            const resp = await fetch(file + '?t=' + Date.now(), {cache:'no-store'});
            if (!resp.ok) return;
            const data = await resp.json();
            const cases = data.test_cases || [];
            if (cases.length === 0) return;
            document.getElementById(statId).textContent = cases.length;
            renderTestCases(cases, containerId);
        } catch (e) {}
    }

    function renderTestCases(cases, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';

        cases.forEach((tc, idx) => {
            const prioClass = tc.priority_id <= 1 ? 'p0' : tc.priority_id === 2 ? 'p1' : tc.priority_id === 3 ? 'p2' : 'p3';
            const prioLabel = tc.priority_id <= 1 ? 'P0 Critical' : tc.priority_id === 2 ? 'P1 High' : tc.priority_id === 3 ? 'P2 Medium' : 'P3 Low';

            let stepsHtml = '';
            if (tc.custom_steps_separated) {
                tc.custom_steps_separated.forEach((step, si) => {
                    let ssHtml = '';
                    if (step.screenshot) {
                        ssHtml = `<div class="tc-step-screenshot"><img src="/screenshots/${step.screenshot}" onclick="showImage(this.src)" onerror="this.style.display='none'" alt="step screenshot"></div>`;
                    }
                    stepsHtml += `
                        <li class="tc-step">
                            <div class="tc-step-num">${si + 1}</div>
                            <div class="tc-step-body">
                                <div class="tc-step-action">${step.content || ''}</div>
                                ${step.expected ? `<div class="tc-step-expected">${step.expected}</div>` : ''}
                                ${ssHtml}
                            </div>
                        </li>`;
                });
            }

            const precond = tc.custom_preconds ? `<div class="tc-preconditions"><strong>Preconditions:</strong> ${tc.custom_preconds}</div>` : '';
            const typeLabel = tc.type_id === 1 ? 'Functional' : tc.type_id === 6 ? 'Accessibility' : tc.type_id === 7 ? 'Responsive' : 'Other';

            container.innerHTML += `
                <div class="tc-card">
                    <div class="tc-header">
                        <span class="tc-id">TC-${String(idx + 1).padStart(3, '0')}</span>
                        <span class="tc-title">${tc.title}</span>
                        <span class="tc-priority ${prioClass}">${prioLabel}</span>
                    </div>
                    <div class="tc-type">${typeLabel}</div>
                    ${precond}
                    <ul class="tc-steps">${stepsHtml}</ul>
                </div>`;
        });
    }

    // ---- Screenshots ----
    async function loadScreenshots() {
        try {
            const allImages = [];

            const topResp = await fetch('/screenshots/?t=' + Date.now(), {cache:'no-store'});
            if (!topResp.ok) return;
            const topText = await topResp.text();
            const topDoc = new DOMParser().parseFromString(topText, 'text/html');
            const topLinks = [...topDoc.querySelectorAll('a')].map(a => a.getAttribute('href')).filter(Boolean);

            topLinks.forEach(link => {
                if (link.match(/\.(png|jpg|jpeg)$/i)) {
                    allImages.push({ path: '/screenshots/' + link, name: link });
                }
            });

            const subdirs = topLinks.filter(l => l.endsWith('/') && l !== '../');
            for (const dir of subdirs) {
                try {
                    const subResp = await fetch('/screenshots/' + dir + '?t=' + Date.now(), {cache:'no-store'});
                    if (!subResp.ok) continue;
                    const subText = await subResp.text();
                    const subDoc = new DOMParser().parseFromString(subText, 'text/html');
                    [...subDoc.querySelectorAll('a')].forEach(a => {
                        const href = a.getAttribute('href');
                        if (href && href.match(/\.(png|jpg|jpeg)$/i)) {
                            allImages.push({ path: '/screenshots/' + dir + href, name: dir + href });
                        }
                    });
                } catch (e) {}
            }

            if (allImages.length === 0) return;
            if (allImages.length === knownScreenshots.length) return;
            knownScreenshots = allImages;

            document.getElementById('stat-screenshots').textContent = allImages.length;
            document.getElementById('ss-count').textContent = `(${allImages.length} captured)`;

            const grid = document.getElementById('ss-grid');
            grid.innerHTML = '';

            allImages.reverse().forEach(img => {
                const name = img.name.replace(/\//g, ' / ');
                const parts = img.name.replace('.png', '').split(/[_/]/);
                const ts = parts[parts.length - 1];
                const label = parts.filter(p => !p.match(/^\d{10,}$/)).join(' ');

                grid.innerHTML += `
                    <div class="ss-card">
                        <img src="${img.path}" loading="lazy" onclick="showImage(this.src)" alt="${name}" onerror="this.parentElement.style.display='none'">
                        <div class="ss-info">
                            <div class="ss-name">${label || name}</div>
                            <div class="ss-time">${ts && ts.match(/^\d{10}/) ? new Date(parseInt(ts) * 1000).toLocaleTimeString() : ''}</div>
                        </div>
                    </div>`;
            });
        } catch (e) {
            console.log('Screenshots error:', e);
        }
    }

    // ---- Anomaly Alerts ----
    let lastAlertRunId = null;
    async function loadAlerts() {
        try {
            const resp = await fetch('/web/auto_qa_report.json?t=' + Date.now(), {cache:'no-store'});
            if (!resp.ok) return;
            const data = await resp.json();
            if (!data.status || data.run_id === lastAlertRunId) return;
            lastAlertRunId = data.run_id;
            renderAlerts(data);
        } catch (e) {}
    }

    function renderAlerts(data) {
        const container = document.getElementById('alerts-content');
        const statusEl = document.getElementById('alert-status');

        if (data.status === 'no_anomalies') {
            statusEl.innerHTML = '<span style="color:#22c55e;">No anomalies detected</span>';
            container.innerHTML = '<div class="tc-empty"><p style="color:#22c55e;font-size:16px;">All clear â€” no production anomalies detected</p></div>';
            return;
        }

        const s = data.summary || {};
        const riskColor = s.overall_risk_score >= 70 ? '#ef4444' : s.overall_risk_score >= 40 ? '#f97316' : '#22c55e';
        statusEl.innerHTML = `<span style="color:${riskColor};font-weight:700;">${data.anomalies_detected} anomalies | Risk: ${s.overall_risk_score}/100 | ${s.recommendation}</span>`;

        let html = `
            <div style="background:#1a1a2e;border:2px solid ${riskColor};border-radius:12px;padding:20px;margin-bottom:16px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <div style="font-size:18px;font-weight:700;">Production Incident Detected</div>
                    <div style="font-size:24px;font-weight:800;color:${riskColor};">${s.overall_risk_score}/100 RISK</div>
                </div>
                <div style="display:flex;gap:20px;margin-bottom:12px;">
                    <div><span style="color:#888;">Service:</span> <strong>${data.service}</strong></div>
                    <div><span style="color:#888;">Anomalies:</span> <strong style="color:#ef4444;">${data.anomalies_detected}</strong></div>
                    <div><span style="color:#888;">Crashes:</span> <strong style="color:#f97316;">${data.crashes_processed}</strong></div>
                    <div><span style="color:#888;">Recommendation:</span> <strong style="color:${riskColor};">${s.recommendation}</strong></div>
                </div>
                <div style="font-size:12px;color:#aaa;">${s.summary_message || ''}</div>
            </div>`;

        (data.results || []).forEach((r, i) => {
            const ca = r.code_analysis || {};
            const rt = r.reproduction_test || {};
            const reproIcon = rt.reproduced ? '&#x2705;' : '&#x274C;';
            const statusColor = r.status === 'processed' ? '#00d2ff' : '#f97316';

            html += `
                <div class="tc-card" style="border-left:3px solid ${statusColor};">
                    <div class="tc-header">
                        <span class="tc-id">${r.crash_id || 'CRASH-' + (i+1)}</span>
                        <span class="tc-title">${ca.likely_cause || 'Crash Analysis'}</span>
                        <span class="tc-priority ${r.severity === 'critical' ? 'p0' : r.severity === 'high' ? 'p1' : 'p2'}">${r.severity || 'medium'}</span>
                    </div>
                    <div style="display:flex;gap:20px;margin:10px 0;font-size:12px;">
                        <div><span style="color:#888;">Reproducible:</span> ${reproIcon} ${ca.is_reproducible ? 'Yes' : 'No'} (${((ca.confidence || 0) * 100).toFixed(0)}% confidence)</div>
                        <div><span style="color:#888;">Test Result:</span> ${rt.reproduced ? '<span style="color:#ef4444;">REPRODUCED</span>' : '<span style="color:#22c55e;">Not reproduced</span>'}</div>
                        ${rt.test_duration_seconds ? `<div><span style="color:#888;">Duration:</span> ${rt.test_duration_seconds}s</div>` : ''}
                    </div>
                    ${ca.affected_files ? `<div style="font-size:11px;color:#888;margin:6px 0;">Affected: ${ca.affected_files.join(', ')}</div>` : ''}
                    ${r.qa_recommendation ? `<div style="font-size:12px;background:#15152a;padding:10px;border-radius:6px;margin-top:8px;line-height:1.5;">${r.qa_recommendation}</div>` : ''}
                </div>`;
        });

        html += `<div style="font-size:10px;color:#555;margin-top:12px;">Report ID: ${data.run_id} | ${data.timestamp}</div>`;
        container.innerHTML = html;
    }

    // ---- Refresh ----
    async function refreshAll() {
        try {
            await Promise.all([loadGraph(), loadTestCases(), loadAlerts(), loadScreenshots()]);
        } catch (e) { console.warn('refresh error:', e); }
    }

    function toggleAutoRefresh() {
        autoRefresh = !autoRefresh;
        const btn = document.getElementById('btn-auto');
        if (autoRefresh) {
            btn.textContent = 'Live';
            btn.classList.add('active');
            document.querySelector('.pulse').style.display = 'inline-block';
            refreshInterval = setInterval(refreshAll, 2000);
        } else {
            btn.textContent = 'Paused';
            btn.classList.remove('active');
            document.querySelector('.pulse').style.display = 'none';
            clearInterval(refreshInterval);
        }
    }

    refreshAll();
    refreshInterval = setInterval(refreshAll, 2000);
    </script>
</body>
</html>
